<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Today’s Reading</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link rel="manifest" href="manifest.json">

  <style>
    body {
      margin: 0;
      background: #000;
      color: #fff;
      font-family: Georgia, serif;
      height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }

    #app {
      max-width: 820px;
      padding: 48px 32px;
      text-align: center;
    }

    #brand {
      font-size: 14px;
      letter-spacing: 0.6px;
      opacity: 0.6;
      margin-bottom: 6px;
    }

    #subtext {
      font-size: 13px;
      opacity: 0.4;
      margin-bottom: 26px;
    }

    #sentence {
      font-size: clamp(32px, 4vw, 46px);
      line-height: 1.55;
      min-height: 140px;
      opacity: 0;
      transition: opacity 0.4s ease;
    }

    .fact {
      color: #b11226 !important;
      font-weight: 600;
      -webkit-text-fill-color: #b11226;
    }

    #controls {
      margin-top: 36px;
    }

    .speedBtn {
      background: #1c1c1c;
      color: #bbb;
      border: 1px solid #333;
      padding: 8px 18px;
      margin: 4px;
      border-radius: 999px;
      cursor: pointer;
      font-size: 13px;
      letter-spacing: 0.3px;
    }

    .speedBtn.active {
      background: #b11226;
      color: #fff;
      border-color: #b11226;
    }

    .reading #brand,
    .reading #subtext {
      display: none;
    }
  </style>
</head>

<body>

<div id="app">
  <div id="brand">Today’s Reading</div>
  <div id="subtext">Preparing today’s briefing…</div>
  <div id="sentence"></div>

  <div id="controls">
    <button class="speedBtn" data-speed="1.6">Slow</button>
    <button class="speedBtn active" data-speed="1.0">Medium</button>
    <button class="speedBtn" data-speed="0.5">Fast</button>
  </div>
</div>

<script>
/* =========================
   CONFIG
========================= */

const BASE_URL =
  "https://docs.google.com/spreadsheets/d/e/2PACX-1vTW5lNRGcxIOyAqp-phNcxFHnhbiG6p8TRTbzRZLlGClICQ_BJ0QH939XN8bTMc8lDnnhpFzLORikxL/pub?output=csv";

const TABS = [
  { name: "India_Geo", gid: "0" },
  { name: "World_Signal", gid: "1804445303" },
  { name: "This_Day", gid: "1108904034" }
];

const SECTION_PAUSE_MS = 700;

/* =========================
   STATE
========================= */

let allSentences = [];
let index = 0;
let timer = null;
let speedMultiplier = 1.0;

const sentenceEl = document.getElementById("sentence");
const speedBtns = document.querySelectorAll(".speedBtn");

/* =========================
   UTILS
========================= */

function todayString() {
  const d = new Date();
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
}

function clean(v="") {
  return v.replace(/^"|"$/g, "").trim();
}

function parseCSVLine(line) {
  const out = [];
  let cur = "", q = false;
  for (let i=0;i<line.length;i++) {
    const c = line[i];
    if (c === '"' && line[i+1] === '"') { cur += '"'; i++; }
    else if (c === '"') q = !q;
    else if (c === "," && !q) { out.push(cur); cur=""; }
    else cur += c;
  }
  out.push(cur);
  return out;
}

function getDisplayTime(s) {
  const w = s.replace(/<[^>]+>/g,"").split(" ").length;
  let base = 3000;
  if (w<=6) base=2200;
  else if (w<=10) base=3000;
  else if (w<=14) base=3800;
  else base=4500;
  return base * speedMultiplier;
}

function highlightFacts(t) {
  t = t.replace(/\b\d+(\.\d+)?%?\b/g, m => `<span class="fact">${m}</span>`);
  t = t.replace(/\b([A-Z][a-z]+(?:\s[A-Z][a-z]+)*)\b/g,
    m => `<span class="fact">${m}</span>`);
  return t;
}

/* =========================
   SPEED
========================= */

speedBtns.forEach(b => {
  b.onclick = () => {
    speedBtns.forEach(x=>x.classList.remove("active"));
    b.classList.add("active");
    speedMultiplier = parseFloat(b.dataset.speed);
  };
});

/* =========================
   LOAD
========================= */

async function loadAllTabs() {
  const today = todayString();
  allSentences = [];

  for (const tab of TABS) {
    const res = await fetch(`${BASE_URL}&gid=${tab.gid}`, { cache:"no-store" });
    const text = await res.text();
    const rows = text.trim().split("\n").slice(1);

    const s = rows
      .map(parseCSVLine)
      .map(c => ({ d:clean(c[0]), t:c[1], o:Number(clean(c[2])) }))
      .filter(r => r.d===today && r.t)
      .sort((a,b)=>a.o-b.o)
      .map(r=>r.t);

    if (s.length) {
      allSentences.push(...s, "__SECTION_BREAK__");
    }
  }
  if (allSentences.at(-1)==="__SECTION_BREAK__") allSentences.pop();
}

/* =========================
   FLOW
========================= */

function showSentence() {
  if (index >= allSentences.length) {
    sentenceEl.style.opacity=0;
    setTimeout(()=>{
      sentenceEl.innerHTML="That’s all for today.";
      sentenceEl.style.opacity=1;
    },400);
    return;
  }

  const cur = allSentences[index++];
  if (cur==="__SECTION_BREAK__") {
    sentenceEl.style.opacity=0;
    return setTimeout(showSentence, SECTION_PAUSE_MS);
  }

  sentenceEl.style.opacity=0;
  setTimeout(()=>{
    sentenceEl.innerHTML = highlightFacts(cur);
    sentenceEl.style.opacity=1;
    timer = setTimeout(showSentence, getDisplayTime(cur));
  },400);
}

async function startReading() {
  await loadAllTabs();
  if (!allSentences.length) {
    sentenceEl.innerHTML="Today’s briefing will be available soon.";
    sentenceEl.style.opacity=1;
    return;
  }

  index=0;
  setTimeout(()=>{
    document.body.classList.add("reading");
    showSentence();
  },900);
}

/* =========================
   INIT (FORCED FIRST PAINT)
========================= */

window.onload = () => {
  requestAnimationFrame(() => {
    setTimeout(startReading, 100);
  });
};
</script>

</body>
</html>
