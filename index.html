<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Today’s Reading</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- PWA manifest (safe even if ignored) -->
  <link rel="manifest" href="manifest.json">

  <style>
    body {
      margin: 0;
      background: #000;
      color: #fff;
      font-family: Georgia, serif;
      height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }

    #app {
      max-width: 820px;
      padding: 48px 32px;
      text-align: center;
    }

    #sentence {
      font-size: clamp(32px, 4vw, 46px);
      line-height: 1.55;
      min-height: 140px;
      opacity: 0;
      transition: opacity 0.4s ease;
    }

   .fact {
  color: #b11226 !important;
  font-weight: 600;
  -webkit-text-fill-color: #b11226;
}

    #controls {
      margin-top: 36px;
    }

    .speedBtn {
      background: #1c1c1c;
      color: #bbb;
      border: 1px solid #333;
      padding: 8px 18px;
      margin: 4px;
      border-radius: 999px;
      cursor: pointer;
      font-size: 13px;
      letter-spacing: 0.3px;
    }

    #brand {
      font-size: 14px;
      letter-spacing: 0.6px;
      opacity: 0.6;
      margin-bottom: 6px;
      }

#subtext {
  font-size: 13px;
  opacity: 0.4;
  margin-bottom: 26px;
}

.loading #sentence {
  display: none;
}

    .reading #brand,
    .reading #subtext {
    display: none;
    }

    .speedBtn.active {
      background: #b11226;
      color: #fff;
      border-color: #b11226;
    }
  </style>
</head>

<body>

<div id="app">
  <div id="brand">Today’s Reading</div>
  <div id="subtext">Preparing today’s briefing…</div>
  <div id="sentence"></div>

  <div id="controls">
    <button class="speedBtn" data-speed="1.6">Slow</button>
    <button class="speedBtn active" data-speed="1.0">Medium</button>
    <button class="speedBtn" data-speed="0.5">Fast</button>
  </div>
</div>

<script>
/* =========================
   CONFIG
========================= */
document.body.classList.add("loading");
const BASE_URL =
  "https://docs.google.com/spreadsheets/d/e/2PACX-1vTW5lNRGcxIOyAqp-phNcxFHnhbiG6p8TRTbzRZLlGClICQ_BJ0QH939XN8bTMc8lDnnhpFzLORikxL/pub?output=csv";

const TABS = [
  { name: "India_Geo", gid: "0" },
  { name: "World_Signal", gid: "1804445303" },
  { name: "This_Day", gid: "1108904034" }
];

const SESSION_LIMIT_SECONDS = 600;
const SECTION_PAUSE_MS = 700;

/* =========================
   STATE
========================= */

let allSentences = [];
let index = 0;
let timer = null;
let speedMultiplier = 1.0;

const sentenceEl = document.getElementById("sentence");
const speedBtns = document.querySelectorAll(".speedBtn");

/* =========================
   UTILS
========================= */

// Local date (NO UTC)
function todayString() {
  const now = new Date();
  const y = now.getFullYear();
  const m = String(now.getMonth() + 1).padStart(2, "0");
  const d = String(now.getDate()).padStart(2, "0");
  return `${y}-${m}-${d}`;
}

// Strip quotes + whitespace
function clean(value = "") {
  return value.replace(/^"|"$/g, "").trim();
}

// CSV parser
function parseCSVLine(line) {
  const result = [];
  let current = "";
  let inQuotes = false;

  for (let i = 0; i < line.length; i++) {
    const char = line[i];

    if (char === '"' && line[i + 1] === '"') {
      current += '"';
      i++;
    } else if (char === '"') {
      inQuotes = !inQuotes;
    } else if (char === "," && !inQuotes) {
      result.push(current);
      current = "";
    } else {
      current += char;
    }
  }
  result.push(current);
  return result;
}

function getDisplayTime(sentence) {
  const words = sentence.replace(/<[^>]+>/g, "").split(" ").length;
  let base = 3000;
  if (words <= 6) base = 2200;
  else if (words <= 10) base = 3000;
  else if (words <= 14) base = 3800;
  else base = 4500;
  return base * speedMultiplier;
}

  function highlightFacts(text) {
  // Highlight numbers
  text = text.replace(/\b\d+(\.\d+)?%?\b/g, match =>
    `<span class="fact">${match}</span>`
  );

  // Highlight capitalized proper nouns (simple heuristic)
  text = text.replace(
    /\b([A-Z][a-z]+(?:\s[A-Z][a-z]+)*)\b/g,
    match => `<span class="fact">${match}</span>`
  );

  return text;
}

/* =========================
   SPEED CONTROLS
========================= */

speedBtns.forEach(btn => {
  btn.onclick = () => {
    speedBtns.forEach(b => b.classList.remove("active"));
    btn.classList.add("active");
    speedMultiplier = parseFloat(btn.dataset.speed);
  };
});

/* =========================
   LOAD CONTENT
========================= */

async function loadAllTabs() {
  const today = todayString();
  allSentences = [];

  for (const tab of TABS) {
    const res = await fetch(`${BASE_URL}&gid=${tab.gid}`, { cache: "no-store" });
    const text = await res.text();
    const rows = text.trim().split("\n").slice(1);

    const sentences = rows
      .map(parseCSVLine)
      .map(cols => ({
        date: clean(cols[0]),
        sentence: cols[1],
        order: Number(clean(cols[2]))
      }))
      .filter(row => row.date === today && row.sentence)
      .sort((a, b) => a.order - b.order)
      .map(row => row.sentence);

    if (sentences.length) {
      allSentences.push(...sentences);
      allSentences.push("__SECTION_BREAK__");
    }
  }

  if (allSentences.at(-1) === "__SECTION_BREAK__") {
    allSentences.pop();
  }
}

/* =========================
   READING FLOW
========================= */

function showSentence() {
  if (!allSentences.length || index >= allSentences.length) {
    sentenceEl.style.opacity = 0;
    setTimeout(() => {
      sentenceEl.innerHTML = "That’s all for today.";
      sentenceEl.style.opacity = 1;
    }, 400);
    return;
  }

  const current = allSentences[index];

  if (current === "__SECTION_BREAK__") {
    index++;
    sentenceEl.style.opacity = 0;
    timer = setTimeout(showSentence, SECTION_PAUSE_MS);
    return;
  }

  sentenceEl.style.opacity = 0;
  setTimeout(() => {
    sentenceEl.innerHTML = highlightFacts(current);
    sentenceEl.style.opacity = 1;
    index++;
    timer = setTimeout(showSentence, getDisplayTime(current));
  }, 400);
}

async function startReading() {
  await loadAllTabs();
document.body.classList.remove("loading");

if (!allSentences.length) {
  sentenceEl.innerHTML = "Today’s briefing will be available soon.";
  sentenceEl.style.opacity = 1;
  return;
}

index = 0;

// Let branding breathe before reading starts
setTimeout(() => {
  document.body.classList.add("reading");
  showSentence();
}, 900);
}

/* =========================
   INIT
========================= */

window.onload = startReading;
</script>

</body>
</html>



